# Secrets scanning - check for potential leaked secrets
echo "Checking for potential secrets..."

# Common patterns for secrets (API keys, tokens, passwords)
SECRETS_PATTERN='(password|passwd|pwd|secret|api[_-]?key|apikey|auth[_-]?token|access[_-]?token|private[_-]?key|client[_-]?secret)\s*[:=]\s*["\x27][^"\x27]{8,}'

# Check staged files for secrets (case insensitive), excluding test files
if git diff --cached --name-only | grep -v '__tests__/' | grep -v '\.test\.' | grep -v '\.spec\.' | xargs grep -l -i -E "$SECRETS_PATTERN" 2>/dev/null; then
  echo ""
  echo "WARNING: Potential secrets detected in staged files!"
  echo "Please review the files above and ensure no sensitive data is being committed."
  echo ""
  echo "If this is a false positive, you can bypass with: git commit --no-verify"
  echo ""
  exit 1
fi

# Check for common secret file patterns
SECRET_FILES=$(git diff --cached --name-only | grep -E '\.(env|pem|key|p12|pfx|credentials)$' | grep -v '\.example$' | grep -v '\.sample$' || true)
if [ -n "$SECRET_FILES" ]; then
  echo ""
  echo "WARNING: Potentially sensitive files detected:"
  echo "$SECRET_FILES"
  echo ""
  echo "Please ensure these files should be committed."
  echo "If this is intentional, you can bypass with: git commit --no-verify"
  echo ""
  exit 1
fi

echo "No secrets detected."

# Run lint-staged
npx lint-staged
